name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Print deployment info
        run: |
          echo "ğŸš€ Starting deployment from branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ”” Event: ${{ github.event_name }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: movik/package-lock.json

      - name: Install dependencies
        working-directory: movik
        run: npm ci
        
      - name: Build application
        working-directory: movik
        run: npm run build
        
      - name: Create .nojekyll file
        run: touch movik/dist/.nojekyll
        
      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -la movik/dist/
          if [ ! -f "movik/dist/index.html" ]; then
            echo "Error: index.html not found!"
            exit 1
          fi
          if [ ! -f "movik/dist/.nojekyll" ]; then
            echo "Error: .nojekyll not found!"
            exit 1
          fi
          echo "Build output verified successfully!"

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
      
      - name: Verify Pages configuration
        run: |
          echo "ğŸ“„ Verifying GitHub Pages is configured correctly..."
          echo "If deployment fails, ensure GitHub Pages is enabled in repository settings."
          echo "Settings â†’ Pages â†’ Source should be set to 'GitHub Actions'"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: movik/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Output deployment URL
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“¦ Deployment completed at: $(date)"
